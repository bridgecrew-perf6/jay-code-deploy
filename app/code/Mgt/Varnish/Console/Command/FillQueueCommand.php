<?php
 namespace Mgt\Varnish\Console\Command; use Symfony\Component\Console\Command\Command; use Symfony\Component\Console\Input\InputArgument; use Symfony\Component\Console\Input\InputOption; use Symfony\Component\Console\Input\InputInterface; use Symfony\Component\Console\Input\InputDefinition; use Symfony\Component\Console\Output\OutputInterface; class FillQueueCommand extends Command { const INPUT_STORE_ID = "\x73\x74\157\x72\145\55\x69\x64"; const ENTITY_TYPE_CATEGORY = "\143\x61\164\145\147\x6f\162\x79"; const ENTITY_TYPE_PRODUCT = "\x70\x72\157\x64\165\x63\x74"; const URL_QUEUE_BATCH_SIZE = 2500; protected $logger; protected $storeManager; protected $categoryCollection; protected $urlQueueResource; protected $urlQueue; protected $numberOfUrls = 0; protected $categories = []; protected $state; public function __construct() { goto D21a9; D497d: $this->categoryCollection = $objectManager->get("\x5c\115\141\x67\145\156\164\x6f\x5c\x43\141\x74\x61\x6c\x6f\x67\x5c\x4d\x6f\144\145\x6c\134\122\x65\x73\x6f\x75\162\x63\145\x4d\157\144\x65\x6c\134\103\141\x74\x65\x67\157\162\x79\134\x43\157\x6c\x6c\145\x63\164\151\157\x6e"); goto bd4c7; d7bab: $this->urlQueue = $objectManager->get("\134\x4d\147\x74\134\x56\141\x72\x6e\x69\x73\x68\134\x4d\x6f\x64\145\x6c\x5c\x55\x72\154\121\165\145\165\x65"); goto A4ac8; B7dc6: $this->logger = $objectManager->get("\x5c\x50\163\162\134\114\x6f\147\134\x4c\157\147\x67\x65\x72\x49\156\x74\x65\162\146\141\x63\x65"); goto Eb66d; bd4c7: $this->urlQueueResource = $objectManager->get("\134\115\147\x74\134\126\141\162\x6e\x69\163\x68\134\x4d\157\x64\145\x6c\134\x52\x65\x73\x6f\x75\x72\x63\145\115\157\x64\145\154\134\125\x72\154\x51\x75\x65\165\x65"); goto d7bab; Eb66d: $this->storeManager = $objectManager->get("\134\115\x61\x67\145\x6e\x74\157\x5c\123\164\157\x72\x65\134\115\x6f\144\145\154\134\x53\164\x6f\162\x65\115\141\156\141\x67\x65\162\x49\156\x74\x65\162\146\x61\143\x65"); goto D497d; A4ac8: parent::__construct(); goto E8e32; D21a9: $objectManager = $this->getObjectManager(); goto B7dc6; E8e32: } protected function configure() { goto ec150; Ba98e: $this->setDescription("\x4d\107\x54\x20\x56\141\162\156\x69\163\150\x20\x43\141\x63\150\x65\40\121\165\145\165\x65\40\x46\151\x6c\154\x65\162"); goto C655e; C655e: $this->setDefinition(new InputDefinition(array(new InputOption(self::INPUT_STORE_ID, null, InputOption::VALUE_OPTIONAL, '')))); goto C7a98; ec150: $this->setName("\155\147\164\55\166\141\162\156\151\163\150\x3a\x66\151\154\x6c\55\x71\x75\x65\x75\145"); goto Ba98e; C7a98: parent::configure(); goto a09c3; a09c3: } protected function execute(InputInterface $input, OutputInterface $output) { try { goto D3ca7; ff681: try { $store = $this->storeManager->getStore($storeId); $this->storeManager->setCurrentStore($store); } catch (\Exception $e) { goto D2b38; D2b38: $output->writeln(sprintf("\74\x65\x72\162\x6f\162\x3e\x53\x74\x6f\162\145\40\167\151\x74\150\x20\x49\104\40\x22\x25\163\x22\x20\x64\x6f\x65\163\40\156\x6f\164\40\145\170\x69\x73\164\163\74\x2f\145\162\x72\157\162\76", $storeId)); goto e8613; A6b34: return $this->showStores($output); goto Ed730; e8613: $output->writeln(''); goto c051a; c051a: $output->writeln(sprintf("\74\143\157\155\x6d\145\156\164\x3e\x41\x76\141\151\154\x61\142\x6c\x65\40\123\164\157\162\145\163\x3c\x2f\x63\x6f\x6d\x6d\145\x6e\164\x3e")); goto A6b34; Ed730: } goto Df043; f9834: $output->writeln(sprintf("\x3c\x69\156\146\157\x3e\45\163\x20\x55\x52\114\x73\40\x61\x64\x64\x65\x64\x20\x74\157\40\126\x61\162\156\151\163\x68\x20\121\x75\145\x75\x65\x3c\57\x69\x6e\x66\x6f\x3e", $this->numberOfUrls)); goto e5670; De950: if (!($this->numberOfUrls > 0)) { goto Fbd1e; } goto f9834; e5670: Fbd1e: goto Bd232; e76fd: if (!$storeId) { goto F927c; } goto ff681; Df043: F927c: goto ecc72; D3ca7: ini_set("\x6d\145\x6d\157\162\171\x5f\154\151\155\x69\x74", "\62\x30\x34\70\x4d"); goto Ac58e; Ac58e: $store = null; goto b7b4a; b7b4a: $storeId = (int) $input->getOption(self::INPUT_STORE_ID); goto e76fd; ecc72: $this->addCategoryUrls($store); goto A9e7a; A9e7a: $this->addProductUrls($store); goto De950; Bd232: } catch (\Exception $e) { goto e1b75; cad84: $output->writeln(sprintf("\x3c\145\162\162\157\x72\76\45\x73\74\57\145\162\x72\x6f\x72\x3e", $errorMessage)); goto F839e; e1b75: $errorMessage = $e->getMessage(); goto cad84; F839e: return \Magento\Framework\Console\Cli::RETURN_FAILURE; goto Cea0f; Cea0f: } } protected function addCategoryUrls(\Magento\Store\Model\Store $store = null) { goto ae8a7; ae8a7: $objectManager = $this->getObjectManager(); goto D0721; aa1ab: Ddf52: goto ee14e; B2912: foreach ($urlRewriteCollection as $urlRewrite) { goto afa3d; ccf4a: bea57: goto F078f; A1e13: A8539: goto ccf4a; afa3d: $urlRewriteId = $urlRewrite->getUrlRewriteId(); goto e0306; B123a: $urlRewrites[$urlRewriteId] = $urlRewriteId; goto A1e13; F7eea: $urls[] = ["\163\x74\x6f\x72\x65\137\151\144" => $urlRewrite->getStoreId(), "\160\141\164\150" => $urlRewrite->getRequestPath(), "\160\162\x69\157\162\x69\164\x79" => \Mgt\Varnish\Model\UrlQueue::PRIORITY_MEDIUM]; goto B123a; e0306: if (isset($urlRewrites[$urlRewriteId])) { goto A8539; } goto F7eea; F078f: } goto aa1ab; Fc953: $categoryIds = array_keys($this->categories); goto Dd581; E6449: $urlRewriteCollection->addEntityIdFilter($categoryIds); goto Eb163; Eb163: $urlRewrites = []; goto b9fad; Dd581: $urlRewriteCollection->addEntityTypeFilter(self::ENTITY_TYPE_CATEGORY); goto E6449; b5f97: if (!count($this->categories)) { goto a8ca3; } goto Fc953; c496e: $this->categoryCollection->setStore($store); goto ccda0; Ed5d9: $this->numberOfUrls += count($urls); goto B8b64; Ffd2a: a8ca3: goto f86e9; aea7d: foreach ($this->categoryCollection as $category) { $this->categories[$category->getId()] = $category; Ea75f: } goto D0188; B8b64: $this->urlQueue->addToQueue($urls); goto c408a; Cc01f: acd76: goto C9cef; b9fad: $urls = []; goto B2912; D0188: D1ce2: goto b5f97; D0721: $urlRewriteCollection = $objectManager->create("\134\x4d\x67\x74\134\x56\141\162\156\x69\x73\x68\134\x4d\x6f\144\145\x6c\x5c\122\x65\x73\x6f\165\162\x63\145\x4d\157\144\x65\154\x5c\125\162\x6c\x52\145\167\x72\151\164\145\x5c\125\x72\x6c\x52\x65\167\162\x69\x74\x65\103\x6f\154\154\x65\x63\x74\x69\157\156"); goto e9fb3; c408a: bb09b: goto Ffd2a; ee14e: if (!count($urls)) { goto bb09b; } goto Ed5d9; ccda0: $urlRewriteCollection->addStoreFilter($storeId, false); goto Cc01f; F761e: $storeId = $store->getStoreId(); goto c496e; e9fb3: if (!(null !== $store)) { goto acd76; } goto F761e; C9cef: $this->categoryCollection->addAttributeToSelect("\145\x6e\x74\151\x74\x79\x5f\x69\144"); goto aea7d; f86e9: } protected function addProductUrls(\Magento\Store\Model\Store $store = null) { goto Dd5fe; Dd5fe: if (!count($this->categories)) { goto bd65d; } goto cd909; Cb998: $productVisibility = $objectManager->get("\134\115\141\x67\145\156\164\157\134\103\141\164\141\x6c\x6f\147\134\x4d\x6f\x64\145\154\134\120\x72\x6f\144\165\x63\x74\134\x56\151\x73\x69\142\151\x6c\151\164\171"); goto Ec34a; eb986: foreach ($this->categories as $category) { goto f7341; B775c: $productCollection->addAttributeToSelect(["\145\x6e\x74\x69\x74\x79\137\x69\144", "\x73\164\x61\x74\x75\163"]); goto f66f9; F58b5: $productCollection->setCurPage(++$i); goto F373e; E8bd6: $storeId = $store->getStoreId(); goto Ce5e8; b8ae5: goto b2677; goto a9bdc; d6e95: $break = false; goto C48d3; b421c: if (!(null !== $store)) { goto Cbb70; } goto d6b72; D7514: if ($break == false) { goto E31f4; } goto A6a28; D713d: $productCollection->addCategoryFilter($category); goto d6e95; bde9a: $this->numberOfUrls += count($urls); goto d35b6; Fcbb9: Ce284: goto Cbe0b; d35b6: $this->urlQueue->addToQueue($urls); goto eca89; B4d6b: ca32a: goto A7a2a; C48d3: $i = 0; goto c7eb4; Acd0a: $urlRewriteCollection->addEntityTypeFilter(self::ENTITY_TYPE_PRODUCT); goto B3eff; f7341: $productCollection = $objectManager->create("\134\x4d\141\x67\145\156\164\x6f\134\x43\141\164\x61\154\x6f\147\x5c\x4d\157\x64\145\154\x5c\122\145\x73\x6f\165\x72\143\x65\115\157\x64\145\x6c\134\120\162\157\x64\x75\x63\164\134\103\x6f\154\x6c\x65\x63\164\x69\157\156"); goto B775c; f7894: if (false === empty($entityIds)) { goto e33f0; } goto D2c05; a1887: Cbb70: goto F58b5; D2c05: $break = true; goto b8ae5; f66f9: $productCollection->addAttributeToFilter("\x73\x74\x61\164\x75\163", ["\151\156" => $productStatus->getVisibleStatusIds()]); goto d98a2; A6a28: A2730: goto B4d6b; F362d: if (!(null !== $store)) { goto C8e9d; } goto E8bd6; E17b7: $urls = []; goto E8578; c7eb4: E31f4: goto De86a; C5da5: $entityIds = []; goto A55b0; ca5e0: b2677: goto D7514; a9bdc: e33f0: goto b5bbe; Cbe0b: if (!count($urls)) { goto c33cb; } goto bde9a; eca89: c33cb: goto ca5e0; B3eff: $urlRewriteCollection->addEntityIdFilter($entityIds); goto D5489; b5bbe: $urlRewriteCollection = $objectManager->create("\x5c\x4d\x67\164\x5c\x56\x61\x72\x6e\151\163\150\134\x4d\157\144\145\x6c\134\x52\145\163\x6f\x75\162\143\x65\115\157\144\145\x6c\x5c\x55\x72\154\x52\x65\167\x72\151\x74\145\134\x55\x72\154\122\145\x77\x72\x69\164\x65\103\x6f\154\154\145\143\164\151\157\x6e"); goto F362d; Ce5e8: $urlRewriteCollection->addStoreFilter($storeId, false); goto F51f1; d98a2: $productCollection->setVisibility($productVisibility->getVisibleInSiteIds()); goto D713d; A55b0: foreach ($productCollection as $product) { goto deaec; deaec: $productId = $product->getId(); goto A3f01; afee4: $productIds[$productId] = $productId; goto e3d6e; A8f36: A183a: goto Afb36; b685e: $parentIds = $configurableProduct->getParentIdsByChild($productId); goto A1bc2; A3f01: if (isset($productIds[$productId])) { goto a2755; } goto d829b; eb210: a8ccd: goto B73c7; e3d6e: $entityIds[$productId] = $productId; goto A8f36; A37eb: A6ab6: goto af0b7; Afb36: goto db9ac; goto eb210; c8d0c: a2755: goto A37eb; A5853: $entityIds[$productId] = $productId; goto Dec29; Dec29: db9ac: goto c8d0c; A1bc2: if (!(true === empty($parentIds))) { goto A183a; } goto afee4; d829b: if ("\143\x6f\156\x66\151\x67\165\162\141\142\154\x65" == $product->getTypeId()) { goto a8ccd; } goto b685e; B73c7: $productIds[$productId] = $productId; goto A5853; af0b7: } goto cafa6; De86a: $productCollection->clear(); goto b421c; F51f1: C8e9d: goto Acd0a; D5489: $urlRewrites = []; goto E17b7; F373e: $productCollection->setPageSize(self::URL_QUEUE_BATCH_SIZE); goto C5da5; d6b72: $productCollection->addStoreFilter($store); goto a1887; cafa6: a741f: goto f7894; E8578: foreach ($urlRewriteCollection as $urlRewrite) { goto C039b; C5276: fa8b3: goto C794a; C820b: $urlRewrites[$urlRewriteId] = $urlRewriteId; goto C13c2; D20a9: $urls[] = ["\x73\x74\157\x72\145\x5f\x69\144" => $urlRewrite->getStoreId(), "\x70\x61\x74\150" => $urlRewrite->getRequestPath(), "\160\162\151\x6f\162\x69\x74\171" => \Mgt\Varnish\Model\UrlQueue::PRIORITY_LOW]; goto C820b; C039b: $urlRewriteId = $urlRewrite->getUrlRewriteId(); goto Eeb5c; Eeb5c: if (isset($urlRewrites[$urlRewriteId])) { goto d5ca5; } goto D20a9; C13c2: d5ca5: goto C5276; C794a: } goto Fcbb9; A7a2a: } goto A4076; A4076: f9d81: goto Bae6a; D5d19: $productStatus = $objectManager->get("\134\x4d\x61\147\x65\156\164\157\x5c\x43\x61\164\x61\x6c\157\x67\x5c\115\157\x64\x65\154\x5c\x50\x72\x6f\144\x75\143\x74\x5c\x41\164\164\162\x69\142\165\164\145\134\x53\157\165\x72\143\x65\x5c\123\x74\141\164\165\x73"); goto Cb998; Bae6a: bd65d: goto c6f18; f3952: $configurableProduct = $objectManager->get("\x5c\x4d\x61\x67\145\x6e\x74\157\134\x43\157\156\146\x69\x67\x75\x72\141\x62\x6c\x65\120\x72\157\x64\165\143\164\134\x4d\157\x64\x65\154\x5c\122\145\163\x6f\165\x72\x63\x65\115\x6f\144\x65\x6c\134\120\162\157\x64\165\143\x74\x5c\124\x79\x70\x65\x5c\x43\x6f\x6e\146\x69\147\x75\162\141\142\154\x65"); goto D5d19; cd909: $objectManager = $this->getObjectManager(); goto f3952; Ec34a: $productIds = []; goto eb986; c6f18: } protected function getObjectManager() { $objectManager = \Magento\Framework\App\ObjectManager::getInstance(); return $objectManager; } protected function showStores(OutputInterface $output) { goto E2832; E0074: foreach ($stores as $store) { goto Bac22; E44c6: $table->addRow($row); goto Df2e3; Df2e3: cc330: goto bfc41; Bac22: $row = [$store->getStoreId(), $store->getBaseUrl()]; goto E44c6; bfc41: } goto Dbde4; a762c: $table->render($output); goto e6f5c; f5c90: $stores = $this->storeManager->getStores(); goto E0074; Dbde4: D1819: goto a762c; c0e87: $table->setHeaders(["\123\x74\x6f\162\145\40\x49\104", "\102\141\163\145\40\125\122\x4c"]); goto f5c90; E2832: $table = $this->getHelperSet()->get("\x74\141\x62\154\x65"); goto c0e87; e6f5c: } }
